#include "framerec.h"
/////////////////////////////////////////////////////////////////////////////////////
FrameReceiver::FrameReceiver(QSettings *settings) :
    _settings(settings),
    _sharedMem(new SharedMem(_settings)),
    _frame(new Frame),
    _mutex(new QMutex),
    _stopped(false)
{
    this->moveToThread(this);
    this->start(QThread::NormalPriority);
}
/////////////////////////////////////////////////////////////////////////////////////
FrameReceiver::~FrameReceiver()
{
    this->stop();
    if(!this->wait(_termTimeout))   this->terminate();
    delete _mutex;
    delete _frame;
    delete _sharedMem;
}
/////////////////////////////////////////////////////////////////////////////////////
void FrameReceiver::run()
{
    while(!_stopped)
    {
        if(_sharedMem->waitForData())
        {
            if(_mutex->tryLock(_timeout))
            {
                _sharedMem->readFrame(_frame);
                _mutex->unlock();
            }
            emit frameReady(_frame, _mutex);
        }
    }
}
/////////////////////////////////////////////////////////////////////////////////////
void FrameReceiver::stop()
{
    _stopped = true;
}
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
